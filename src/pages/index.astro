---
import Layout from '@/layouts/Layout.astro';
import UserSection from '@/components/UserSection.astro';
import PostCard from '@/components/PostCard.astro';

// Get user from middleware
const user = Astro.locals.user;

// Fetch recent posts from D1
const runtime = Astro.locals.runtime;
let posts: any[] = [];

if (runtime?.env?.DB) {
  try {
    const result = await runtime.env.DB.prepare(`
      SELECT p.id, p.title, p.slug, p.excerpt, p.featured_image_url, p.published_at, p.author_id,
             u.username as author_name, u.avatar_url as author_avatar
      FROM posts p
      LEFT JOIN users u ON p.author_id = u.id
      WHERE p.status = 'published'
      ORDER BY p.published_at DESC
      LIMIT 5
    `).all();
    posts = result.results || [];
  } catch (e) {
    console.error('Failed to fetch posts:', e);
  }
}
---

<Layout title="Blog">
  <div class="container">
    <header>
      <h1>üìù XAOSTECH Blog</h1>
      <p class="subtitle">Thoughts, tutorials, and updates from the XAOSTECH team</p>
    </header>
    
    <UserSection user={user} showNewPost={true} />
    
    <section class="posts">
      {posts.length > 0 ? (
        posts.map((post) => <PostCard post={post} />)
      ) : (
        <p class="no-posts">No posts yet. Check back soon!</p>
      )}
    </section>
    
    {posts.length > 0 && (
      <div class="view-all">
        <a href="/posts" class="btn btn-secondary">View All Posts ‚Üí</a>
      </div>
    )}
  </div>
  
  <footer>
    <a href="https://xaostech.io">‚Üê Back to XAOSTECH</a>
  </footer>
</Layout>

<style>
  header {
    text-align: center;
    margin-bottom: 2rem;
  }
  
  header h1 {
    color: var(--primary);
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }
  
  .subtitle {
    opacity: 0.7;
  }
  
  .posts {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .no-posts {
    text-align: center;
    opacity: 0.6;
    padding: 3rem;
    background: var(--card-bg);
    border-radius: 12px;
  }
  
  .view-all {
    text-align: center;
    margin-top: 2rem;
  }
  
  footer {
    text-align: center;
    margin-top: 4rem;
    opacity: 0.5;
    font-size: 0.85rem;
  }
</style>
